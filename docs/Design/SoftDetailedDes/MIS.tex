\documentclass[12pt, titlepage]{article}

\usepackage{amsmath, mathtools}

\usepackage[round]{natbib}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{colortbl}
\usepackage{xr}
\usepackage{hyperref}
\usepackage{longtable}
\usepackage{xfrac}
\usepackage{tabularx}
\usepackage{float}
\usepackage{siunitx}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage[section]{placeins}
\usepackage{caption}
\usepackage{fullpage}

\hypersetup{
bookmarks=true,     % show bookmarks bar?
colorlinks=true,       % false: boxed links; true: colored links
linkcolor=red,          % color of internal links (change box color with linkbordercolor)
citecolor=blue,      % color of links to bibliography
filecolor=magenta,  % color of file links
urlcolor=cyan          % color of external links
}

\usepackage{array}

\externaldocument{../../SRS/SRS}

\input{../../Comments}
\input{../../Common}

\begin{document}

\title{Module Interface Specification for \progname{}}

\author{\authname}

\date{\today}

\maketitle

\pagenumbering{roman}

\section{Revision History}

\begin{tabularx}{\textwidth}{p{3cm}p{2cm}X}
\toprule {\bf Date} & {\bf Version} & {\bf Notes}\\
\midrule
16/01/23 & 1.0 & Abi started M4, M5, M7\\
17/01/23  & 1.1 & Abi finished M4, M5, M7, Intro\\
18/01/23 & 1.2 & Anthony finished M2,3,6,8\\
\bottomrule
\end{tabularx}

~\newpage

\section{Symbols, Abbreviations and Acronyms}

See SRS Documentation \href{https://github.com/NevoAbigail/Capstone/blob/main/docs/SRS/SRS.pdf}{here}.

%\wss{Also add any additional symbols, abbreviations or acronyms}

\newpage

\tableofcontents

\newpage

\pagenumbering{arabic}

\section{Introduction}

The following document details the Module Interface Specifications for
SmartLock, a bluetooth-driven bike lock brough to you by the Locked \& Loaded team. The SmartLock allows users to unlock their bike remotely using Bluetooth. 

%\wss{Fill in your project name and description}

Complementary documents include the System Requirement Specifications
and Module Guide.  The full documentation and implementation can be
found in \href{https://github.com/NevoAbigail/Capstone}{the GitHub repo}. % \wss{provide the url for your repo}

Note that not every module documented in the Module Guide has a corresponding section in this document, as an MIS was only completed for every software module, and not those modules with a hardware implementation. 

\section{Notation}

\progname \ uses functions, which
are defined by the data types of their inputs and outputs. Local functions are
described by giving their type signature followed by their specification.

\section{Module Decomposition}

The following table is taken directly from the \href{https://github.com/NevoAbigail/Capstone/blob/main/docs/Design/SoftArchitecture/MG.pdf}{Module Guide document} for this project.

\begin{table}[h!]
\centering
\begin{tabular}{p{0.3\textwidth} p{0.6\textwidth}}
\toprule
\textbf{Level 1} & \textbf{Level 2}\\
\midrule

\multirow{2}{0.3\textwidth}{Hardware-Hiding Module} & User Input to Phone Module \\
& Solenoid Actuation Module \\
\midrule

\multirow{6}{0.3\textwidth}{Behaviour-Hiding Module} %& Engage Status Signal Module  \\
& Arduino Bluetooth Communication Module\\
& Mobile App Bluetooth Communication Module\\
& Battery Status Module \\
& Location Module  \\
& Lock Frame Module \\
\midrule

\multirow{5}{0.3\textwidth}{Software Decision Module} & User Disengage Module \\
& Hardware Disengage Module \\
& Battery Module \\
& Locking Mechanism Module \\
\bottomrule

\end{tabular}
\caption{Module Hierarchy}
\label{TblMH}
\end{table}

\newpage




\section{MIS of Arduino Bluetooth Communication Module} \label{mABC}

\subsection{Module}
disengageControl.ino

\subsection{Syntax}

\subsubsection{Exported Constants}

\begin{center}
\begin{tabular}{p{4cm} p{2cm} p{6cm}}
\hline
\textbf{Name} & \textbf{Value} & \textbf{Description} \\
\hline
BAUD\_RATE & 9600 & Serial communication baud rate \\
GREEN\_PIN & 23 & Pin for green LED onboard \\
\hline
\end{tabular}
\end{center}

\subsubsection{Exported Access Programs}

\begin{center}
\begin{tabular}{p{2cm} p{2cm} p{2cm} p{2cm} p{5cm}}
\hline
\textbf{Name} & \textbf{In} & \textbf{Transition} & \textbf{Out} & \textbf{Exception} \\
\hline
setup & None & loop & None & BLE fails: print message  \\
loop & None & \hyperref[mHD]{Hardware Disengage Module} & None & BLE fails: print message \\
\hline
\end{tabular}
\end{center}

\subsection{Semantics}

\subsubsection{State Variables}

\begin{center}
\begin{tabular}{p{4cm} p{4cm} p{6cm}}
\hline
\textbf{Name} & \textbf{Type} & \textbf{Description} \\
\hline
nanoService & BLEService & BLE service UUID\\
commCharacteristic & BLEByteCharacteristic & BLE Characteristic UUID\\
password & int & password for disengage \\
productName & char array & name to appear when device BL advertised \\
central & BLEDevice & connected central device \\
\hline
\end{tabular}
\end{center}

\subsubsection{Access Routine Semantics}

\noindent setup
\begin{itemize}
\item Begins serial communication operating at BAUD\_RATE
\item Configures output pins specified by Exported Constants
\item Configures BLE settings: name, advertising service, characteristic, and initial value for the characteristic. Do this using functions from the Arduino Bluetooth library, use  \textit{\#include ArduinoBLE.h}
\item Begins advertising BL service, and awaits for connections, prints status message

\end{itemize}

\noindent loop
\begin{itemize}
\item Listens for central device to connect using aforementioned Bluetooth library
\item If a central device is connected, print a statement of this status and transition to \hyperref[mHD]{Hardware Disengage Module}
\item When the central device disconnects, print a message indicating this new status
\end{itemize}

\subsubsection{Local Functions}

A list of functions used in this module from Arduino Bluetooth library, \href{https://www.arduino.cc/reference/en/libraries/arduinoble/}{see official Arduino documentation here}
\begin{itemize}
    \item setDeviceName()
    \item setLocalName()
    \item setAdvertisedService()
    \item addCharacteristic()
    \item addService()
    \item writeValue()
    \item advertise()
\end{itemize}


%%END OF ARDUINO BLUETOOTH COMM MODULE



\section{MIS of Hardware Disengage Module} \label{mHD}

\subsection{Module}
disengageControl.ino

\subsection{Syntax}

\subsubsection{Exported Constants}

\begin{center}
\begin{tabular}{p{4cm} p{2cm} p{6cm}}
\hline
\textbf{Name} & \textbf{Value} & \textbf{Description} \\
\hline
BAUD\_RATE & 9600 & Serial communication baud rate \\
GREEN\_PIN & 23 & Pin for green LED onboard \\
TRANSISTOR\_OUT & 9 & Output pin for signal to transistor \\
\hline
\end{tabular}
\end{center}

\subsubsection{Exported Access Programs}

\begin{center}
\begin{tabular}{p{2cm} p{2cm} p{4cm} p{2cm} p{2cm}}
\hline
\textbf{Name} & \textbf{In} & \textbf{Transition} & \textbf{Out} & \textbf{Exception} \\
\hline
setup & None & loop & None & - \\
loop & None & see Access Routine Semantics & None & -\\
\hline
\end{tabular}
\end{center}

\subsection{Semantics}

\subsubsection{State Variables}

\begin{center}
\begin{tabular}{p{4cm} p{4cm} p{6cm}}
\hline
\textbf{Name} & \textbf{Type} & \textbf{Description} \\
\hline
password & int & password for disengage \\
central & BLEDevice & connected central device \\
\hline
\end{tabular}
\end{center}

\subsubsection{Access Routine Semantics}

\noindent setup
\begin{itemize}
\item Begins serial communication operating at BAUD\_RATE
\item Configures output pins specified by Exported Constants
\end{itemize}

\noindent loop
\begin{itemize}
\item While a central device is connected;
\item If the central device writes a value to the Arduino;
\item If the written value matches \textit{password};
\item Then print a message indicating this status, turn on the onboard green LED (write a LOW signal to GREEN\_PIN, and write a HIGH signal to TRANSISTOR\_OUT;
\item Else, turn off the onboard green LED (write a HIGH signal to GREEN\_PIN, and write a LOW signal to TRANSISTOR\_OUT;
\end{itemize}

\subsubsection{Local Functions}

No local functions.


%%END OF HARDWARE DISENGAGE


\section{MIS of Mobile App Bluetooth Communication Module} \label{mHD}

\subsection{Module}
device.dart

\subsection{Semantics}

\subsubsection{State Variables}

\begin{center}
\begin{tabular}{p{4cm} p{4cm} p{6cm}}
\hline
\textbf{Name} & \textbf{Type} & \textbf{Description} \\
\hline
locking & int & request to engage the lock (value of 1 to engage) \\
isConnected & int & wether SmartLock App is connected to the Arduino (value of 1 if connected) \\
password & int & the value of the user inputted password \\
\hline
\end{tabular}
\end{center}

\subsubsection{Local Functions}

\noindent buildServiceTiles
\begin{itemize}
\item Constructs the layout of the screen displaying the connected device
\item Configures the buttons to disengage lock by sending the user inputted password to the Arduino 
\end{itemize}

\begin{itemize}
\item inputs: password
\item transition: none
\item output: password to Arduino
\item exception: none
\end{itemize}

\noindent Widget build (BuildContext context)
\begin{itemize}
\item Constructs the layout of the screen displaying the bluetooth devices
\item Displays the connection status of the selected bluetooth device
\end{itemize}

\begin{itemize}
\item inputs: none
\item transition: none
\item output: connection status displayed to user and device information
\item exception: none
\end{itemize}
% End of Mobile App Bluetooth Communication Module

\section{MIS of Battery Status Module} \label{mHD}

\subsection{Module}
main.dart

\subsection{Semantics}

\subsubsection{State Variables}

\begin{center}
\begin{tabular}{p{4cm} p{4cm} p{6cm}}
\hline
\textbf{Name} & \textbf{Type} & \textbf{Description} \\
\hline
batteryPercentage & int & the calculated value of the battery percentage \\
completedActuations & int & the total number of actuations to engage the lock completed \\
\hline
\end{tabular}
\end{center}

\subsubsection{Local Functions}

\noindent getLocalPath
\begin{itemize}
\item This functions gets the local directory of the application
\end{itemize}

\noindent getLocalFile
\begin{itemize}
\item This function gets the local file that stores the battery percentage and number of completed actuations 
\item It searches for a file called 'batteryInfo.txt'
\end{itemize}

\noindent writeBattery
\begin{itemize}
\item This function reads the value of the calculated battery percentage from the 'batteryInfo.txt' file
\end{itemize}

\noindent readBattery
\begin{itemize}
\item This function writes the value of the calculated battery percentage to the 'batteryInfo.txt' file
\item If this file can not be found (if this the first time the application is run) it will create a new file titled 'batteryInfo.txt'
\end{itemize}

\noindent batteryCalculator
\begin{itemize}
\item This function is used to calculate the amount of battery remaining
\item This is done by dividing the total capacity of the battery by the power drawn from completing on actuation of engaging the lock
\end{itemize}

\begin{itemize}
\item inputs: batteryPercentage
\item transition: none
\item output: new battery percentage
\item exception: none
\end{itemize}

%% END OF BATTERY STATUS MODULE

\section{MIS of Location Module} \label{mHD}

\subsection{Module}
currentLocation.dart

\subsection{Semantics}

\subsubsection{State Variables}

\begin{center}
\begin{tabular}{p{4cm} p{4cm} p{6cm}}
\hline
\textbf{Name} & \textbf{Type} & \textbf{Description} \\
\hline
locLAT & double & the latitude coordinates of the users current location \\
locLOG & double & the longitude coordinates of the users current location \\
\hline
\end{tabular}
\end{center}

\subsubsection{Local Functions}

\noindent getLocalPath
\begin{itemize}
\item This functions gets the local directory of the application
\end{itemize}

\noindent getLocalFileLat
\begin{itemize}
\item This function gets the local file that stores the latitude coordinates
\item It searches for a file called 'locationLat.txt'
\end{itemize}

\noindent getLocalFileLog
\begin{itemize}
\item This function gets the local file that stores the longitude coordinates
\item It searches for a file called 'locationLog.txt'
\end{itemize}

\noindent readLat
\begin{itemize}
\item This function reads the value of the latitude coordinates from the 'locationLat.txt' file
\item If this file can not be found (if this the first time the application is run) it will create a new file titled 'locationLat.txt'
\end{itemize}

\noindent readLog
\begin{itemize}
\item This function reads the value of the longitude coordinates from the 'locationLog.txt' file
\item If this file can not be found (if this the first time the application is run) it will create a new file titled 'locationLog.txt'
\end{itemize}

\noindent writeLat
\begin{itemize}
\item This function writes the value of the latitude coordinates to the 'locationLat.txt' file
\end{itemize}

\noindent writeLog
\begin{itemize}
\item This function writes the value of the latitude coordinates to the 'locationLog.txt file
\end{itemize}

\noindent Widget build(BuildContext context)
\begin{itemize}
\item This function builds the layout of the screen including the Google Maps API and getCurrentLocation button
\item When interacted with, it places a marker showing the current location of the user and stores those coordinates
\end{itemize}

\begin{itemize}
\item inputs: locationLat and locationLog
\item transition: none
\item output: new locationLat and locationLog
\item exception: none
\end{itemize}

\noindent determinePosition()
\begin{itemize}
\item This function gets user permission to use their mobile GPS
\end{itemize}

\begin{itemize}
\item inputs: none
\item transition: none
\item output: none
\item exception: If the user denies permission then disable Google Maps API 
\end{itemize}


%% END OF LOCATION MODULE

\section{MIS of M3} \label{OutputParameters} 

\subsection{Output Parameter Module}

As described in the \href{https://github.com/NevoAbigail/Capstone/blob/main/docs/Design/SoftArchitecture/MG.pdf}{MG document}, the Output Parameter Module (M3) is responsible for displaying the battery status, location, and the engaged status signal. In this module, there are submodules to store the current location requested by the user as coordinates on a text file. 

\subsection{Uses}


\subsection{Syntax}

\subsubsection{Exported Constants}

N/A

\subsubsection{Exported Access Programs}

N/A

\subsection{Semantics}

\subsubsection{State Variables}

\begin{itemize}
\item locationLatitude, type: String
\item locationLongitude, type: String
\end{itemize}


\subsubsection{Environment Variables}

None.


\subsubsection{Assumptions}

None.

\subsubsection{Access Routine Semantics}

\noindent loadScreen():
This routine oversees the layout and UserInterface architecture. It ensures all buttons, labels, and images fall within the constraints of any mobile device. 
\begin{itemize}
\item inputs: storedCurrentLocationButton, bluetoothConnectButton, getLocationButton, batteryButton
\item transition: bluetoothConnectButton, getLocationButton
\item output: display current location and battery percentage
\item exception: none
\end{itemize}

\subsubsection{Local Functions}

None.





\section{MIS of M4} \label{EngageStatus} 

\subsection{Engage Status Signal Module}

As described in the \href{https://github.com/NevoAbigail/Capstone/blob/main/docs/Design/SoftArchitecture/MG.pdf}{MG document}, the Engage Status Signal Module (M4) is responsible for transmitting the engagement status of the lock from the Arduino to the mobile app. If the status reads "engaged", then the Arduino is not currently sending a high signal to the transistor, and the electromagnet remains off, meaning the latch in the locking mechanism is shut. Therefore, if the pin is in the lock, it will not be able to move. If the status reads "disengaged", then the Arduino is currently writing a high signal to the transistor, and the electromagnet is on, opening the latch in the locking mechanism, and allowing the pin to move freely (in or out of the lock). 

\subsection{Uses}


\subsection{Syntax}

\subsubsection{Exported Constants}

N/A

\subsubsection{Exported Access Programs}

N/A

\subsection{Semantics}

\subsubsection{State Variables}

None. 

\subsubsection{Environment Variables}

%\wss{This section is not necessary for all modules.  Its purpose is to capture
%  when the module has external interaction with the environment, such as for a
%  device driver, screen interface, keyboard, file, etc.}

\begin{itemize}
\item e\_BTService, type: BLEService
\item e\_DisengageCharacteristic; type: BLEByteCharacteristic
\end{itemize}

Note that the environment variables are the same as that of M5, as an established Bluetooth connection is a prerequisite of M4, and these variables must still be used to keep the BlueTooth connection active. 

\subsubsection{Assumptions}

%\wss{Try to minimize assumptions and anticipate programmer errors via
%  exceptions, but for practical purposes assumptions are sometimes appropriate.}

This module assumes there is a successful BlueTooth connection established between the Arduino and the mobile app. 

\subsubsection{Access Routine Semantics}


\noindent readEngagementStatus():

This access routine will be implemented on the mobile app, and will read the current value of  e\_DisengageCharacteristic.

\begin{itemize}
\item inputs
\item transition: %\wss{if appropriate} 
\item output: e\_DisengageCharacteristic
\item exception:  
\end{itemize}

\subsubsection{Local Functions}

None.


\section{MIS of M5 \label{WirelessSignalConnection}} 

\subsection{Wireless Signal Connection Module}

As described in the \href{https://github.com/NevoAbigail/Capstone/blob/main/docs/Design/SoftArchitecture/MG.pdf}{MG document}, the Wireless Signal Connection Module (M5) is responsible for establishing a BlueTooth connection between the Arduino and the mobile app.

\subsection{Uses}


\subsection{Syntax}

\subsubsection{Exported Constants}

N/A

\subsubsection{Exported Access Programs}

N/A

\subsection{Semantics}

\subsubsection{State Variables}

None.

\subsubsection{Environment Variables}

\begin{itemize}
\item e\_BTService, type: BLEService
\item e\_DisengageCharacteristic; type: BLEByteCharacteristic
\end{itemize}


\subsubsection{Assumptions}

\begin{itemize}
\item Arduino is powered on.
\end{itemize}

\subsubsection{Access Routine Semantics}

\noindent BTconnect():

This routine creates a BlueTooth connection between the mobile app and the Arduino so that they can send and receive signals from each other. This routine will need an implementation both for the Arduino, and for the mobile app, where the Arduino will act as the peripheral device, and the mobile app will act as the central device. 

\begin{itemize} 
\item inputs: none
\item transition: loadPower(), the access routine of M7, upon successful connection
\item output: none
\item exception: connection status will appear on the mobile app. Therefore, the user will be aware of the connection status, whether that be successful or unsuccessful. 
\end{itemize}

\subsubsection{Local Functions}

None.


\section{MIS of M6} \label{BatteryStatus} 

\subsection{Battery Status Module}

As described in the \href{https://github.com/NevoAbigail/Capstone/blob/main/docs/Design/SoftArchitecture/MG.pdf}{MG document}, the Battery Status Module (M6) is responsible for calculating the battery status. In this module, there are submodules to calculate the amount of battery left. The percentage is shown as a percent of the number of actuations that can be completed till the battery loses power. 

\subsection{Uses}


\subsection{Syntax}

\subsubsection{Exported Constants}

N/A

\subsubsection{Exported Access Programs}

N/A

\subsection{Semantics}

\subsubsection{State Variables}

None.


\subsubsection{Environment Variables}

None.


\subsubsection{Assumptions}

There is an assumption that the power drawn from the Arduino is negligible. Therefore it is not taken into consideration when calculating the battery percentage. 

\subsubsection{Access Routine Semantics}

\noindent getBatteryStatus():
This routine gets the battery amount remaining. This is displayed to the user as a percentage of the number of actuations remaining. 
\begin{itemize}
\item inputs: batteryCalculator()
\item transition: none
\item output: battery percentage as displayed to the user
\item exception: none
\end{itemize}

\subsubsection{Local Functions}

\noindent batteryCalculator():
This function is used to calculate the amount of battery remaining. The output is used in the getBatteryStatus function. The function works by reading the battery percentage from the local text file. It then calculated the remaining battery life by taking how much of the battery has been used and calculating how much is remaining. It then writes that amount back to the local text file. 




\section{MIS of M7  \label{LoadPowerSignal}}

\subsection{Load Power Signal Module}

As described in the \href{https://github.com/NevoAbigail/Capstone/blob/main/docs/Design/SoftArchitecture/MG.pdf}{MG document}, the Load Power Signal Module (M7) is responsible for sending a high power/ON signal to the transistor once a disengage signal is written to the Arduino. An ON signal to the transistor acts as a switch ON, and will power the electromagnet to disengage the lock. 

\subsection{Uses}

\subsection{Syntax}

\subsubsection{Exported Constants}

N/A

\subsubsection{Exported Access Programs}

N/A

\subsection{Semantics}

\subsubsection{State Variables}

None.

\subsubsection{Environment Variables}

\begin{itemize}
\item e\_BTService, type: BLEService
\item e\_DisengageCharacteristic; type: BLEByteCharacteristic
\end{itemize}

Note that the environment variables are the same as that of M5, as an established Bluetooth connection is a prerequisite of M7, and these variables must still be used to keep the BlueTooth connection active. 

\subsubsection{Assumptions}

Assumes M5 has been successfully completed; there is an established BlueTooth connection between the Arduino and the mobile app.

\subsubsection{Access Routine Semantics}

\noindent loadPower():

This access routine is responsible for recieving the signal to disengage the lock, and then, should this signal be received, sending a HIGH signal to the transistor. This will be implemented on the Arduino. 

\begin{itemize}
\item inputs: e\_DisengageCharacteristic
\item transition: none 
\item output: if e\_DisengageCharacteristic has a nonzero value (i.e., the disengage button on the app GUI is pressed), write a HIGH signal to the Arduino pin wired to the corresponding transistor terminal for five seconds (enough time to pull the pin out of the lock, or in other words, unlock your bike). 
\item exception: none 
\end{itemize}

\subsubsection{Local Functions}

\begin{itemize}
\item writeBattery()
\item getBattery()
\end{itemize}

\section{MIS of M8} \label{Location} 

\subsection{Location Module}

As described in the \href{https://github.com/NevoAbigail/Capstone/blob/main/docs/Design/SoftArchitecture/MG.pdf}{MG document}, the Location Module (M8) is responsible for gathering the location data requested by the user. In this module, there are submodules to store the current location requested by the user. The module utilizes the Google Maps API to get the current user location and display it on the main screen. 

\subsection{Uses}


\subsection{Syntax}

\subsubsection{Exported Constants}

N/A

\subsubsection{Exported Access Programs}

N/A

\subsection{Semantics}

\subsubsection{State Variables}

\begin{itemize}
\item locationLatitude, type: String
\item locationLongitude, type: String
\end{itemize}


\subsubsection{Environment Variables}

None.


\subsubsection{Assumptions}

The user is storing their location right next to where they are leaving their bike. 

\subsubsection{Access Routine Semantics}

\noindent updateLocation():
This routine writes to the local text file to store the last location requested by the user.
\begin{itemize}
\item inputs: locationPinButton()
\item transition: none
\item output: none
\item exception: none
\end{itemize}

\noindent getLocation():
This routine reads from the local text file to get the last location requested by the user
\begin{itemize}
\item inputs: none
\item transition: none
\item output: storedCurrentLocationButton
\item exception: none
\end{itemize}

\subsubsection{Local Functions}

\begin{itemize}
\item getLatLocation()
\item getLogLocation()
\item writeLatLocation()
\item writeLogLocation()
\end{itemize}

\newpage

\bibliographystyle {plainnat}
\bibliography {../../../refs/References}

%\newpage

%\section{Appendix} \label{Appendix}

%\wss{Extra information if required}

\end{document}
